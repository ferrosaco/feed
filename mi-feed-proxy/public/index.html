<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Feed de la cocina</title>
  <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@3.6.2/dist/fetch.umd.js"></script>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #000;
      color: #fff;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    header {
      background: #E61C29;
      padding: 20px 30px;
      font-size: 35px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #hora {
      font-size: 23px;
      font-weight: normal;
    }

    /* LAYOUT 16:9: izquierda = llegadas, derecha = horarios */
    .container {
      display: flex;
      height: calc(100vh - 90px);
    }

    .col {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      overflow-x: hidden;
      box-sizing: border-box;
    }

    /* --- AÑADE ESTAS LÍNEAS AQUÍ --- */
    #col-llegadas {
      flex: 0 0 55%; /* No crece, no encoge, base del 65% */
    }

    #col-horarios {
      flex: 0 0 45%; /* No crece, no encoge, base del 35% */
    }
    /* --- FIN DE LAS LÍNEAS A AÑADIR --- */

    .titulo-col {
      font-size: 30px;
      margin-bottom: 15px;
      border-bottom: 2px solid #ffffff;
      padding-bottom: 5px;
    }

    .linea {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 25px;
    }

    .linea h2 {
      margin: 0 0 10px;
      font-size: 28px;
      font-weight: bold;
    }

    .bus {
      font-size: 22px;
      margin-bottom: 6px;
    }

    /* Cajitas de horarios */
    .horarios-lista {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .horario-caja {
      background: #111;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 22px;
      border: 1px solid #444;
      min-width: 80px;

      

      text-align: center;
    }
  </style>
</head>

<body>

  <header>
    <div>Adormideras en directo</div>
    <div id="hora"></div>
  </header>

  <div class="container">
    <div class="col" id="col-llegadas">
      <div class="titulo-col" id="titulo-llegadas">Llegadas</div>
      <div id="contenedor"></div>
    </div>

    <div class="col" id="col-horarios">
      <div class="titulo-col" id="titulo-horarios">Horarios de hoy</div>
      <div id="horarios"></div>
    </div>
  </div>

  
</body>

<!-- ===================================================== -->
<!-- BANDA INFERIOR: lluvia + noticias -->
<!-- ===================================================== -->
<style>
/* Banda inferior fija */
#banda-inferior {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 55px;
    display: flex;
    align-items: center;
    padding: 0 0px;
    box-sizing: border-box;
    z-index: 10000;
    overflow: hidden;
    color: #fff;
    font-size: 28px;
}

#banda-lluvia {
    flex: 0 0 auto;   /* no crece ni se encoge */
    background: #121212;
    margin-right: 0px;
    height: 55px;  /* Añade altura explícita */
    width: 300px;
    white-space: nowrap;
    align: center;  /* Centra verticalmente */
    align-content: center;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
}
#banda-noticias {
  flex-grow: 1;
  overflow: hidden;
  position: relative;
  white-space: nowrap;
  background: #E61C29;
  height: 55px;  /* Añade altura explícita */
  display: flex;
  align-items: center;  /* Centra verticalmente */
  align: center;  /* Centra verticalmente */
    align-content: center;
    text-align: center;
}

#ticker-inner {
  position: absolute;
  white-space: nowrap;
  display: inline-flex;
  gap: 60px;
  left: 0;
  top: 50%;  /* Centra verticalmente */
  transform: translateY(-50%);  /* Centra verticalmente */
  will-change: transform;
}

.ticker-item {
  display: inline-block;
  white-space: nowrap;
  font-size: 28px;  /* Asegura tamaño legible */
  align: center;  /* Centra verticalmente */
    align-content: center;
    text-align: center;
}


</style>

<div id="banda-inferior">
  <div id="banda-lluvia">Cargando lluvia...</div>
  <div id="banda-noticias">
    <div id="ticker-inner"></div>
  </div>
</div>


</html>

<script>
// ============================
// CONFIGURACIÓN GLOBAL
// ============================
var NOMBRES_PARADAS = {};
var LINEA_INFO = {
    500: { nombre: "Línea 5", color: "#6792bc50" },
    300: { nombre: "Línea 3", color: "#BE8B0050" },
    301: { nombre: "Línea 3A", color: "#D3B25550" }
};
var animacionActiva = null; // Para el ticker de noticias


// ============================
// FUNCIÓN DE CARGA PRINCIPAL
// ============================

function cargarDatosDelWrapper() {
    console.log("Llamando al wrapper /api/datos...");
    
    fetch('/api/datos')
        .then(function(resp) {
            if (!resp.ok) { 
                throw new Error("Error del Wrapper: " + resp.status); 
            }
            return resp.json();
        })
        .then(function(data) {
            console.log("Datos recibidos:", data);

            // --- REPARTIR DATOS A LAS FUNCIONES DE PINTADO ---
            // Comprobamos que los datos no sean 'null' (por si una API falló)

            if (data.paradas) {
                procesarParadas(data.paradas); 
            } else {
                console.warn("No se recibieron datos de Paradas.");
            }

            // Damos un pequeño respiro para que NOMBRES_PARADAS se procese
            // antes de intentar pintar las llegadas que dependen de ello.
            setTimeout(function() {
                if (data.llegadas) {
                    pintarLlegadas(data.llegadas); 
                } else {
                    console.warn("No se recibieron datos de Llegadas.");
                    document.getElementById("contenedor").innerHTML = '<p style="color:white;font-size:24px;">Error al cargar llegadas.</p>';
                }
            }, 100); // 100ms de retraso

            if (data.horarios) {
                pintarHorarios(data.horarios); 
            } else {
                console.warn("No se recibieron datos de Horarios.");
                document.getElementById("horarios").innerHTML = '<p style="color:white;font-size:24px;">Error al cargar horarios.</p>';
            }
            
            if (data.clima) {
                pintarClima(data.clima);
            } else {
                console.warn("No se recibieron datos de Clima.");
            }

            if (data.noticias && data.noticias.items) {
                pintarNoticias(data.noticias);
            } else {
                console.warn("No se recibieron datos de Noticias.");
            }
        })
        .catch(function(err) {
            console.error("Falló la carga de datos del wrapper:", err);
            // Mostrar error genérico si todo falla
            document.getElementById("contenedor").innerHTML = '<p style="color:white;font-size:24px;">No se pudo conectar con el servidor.</p>';
            document.getElementById("horarios").innerHTML = '';

        });
}


// ============================
// FUNCIONES PARA "PROCESAR" Y "PINTAR"
// (Estas eran las que estaban vacías)
// ============================

function procesarParadas(textoParadas) {
    console.log("Procesando paradas...");
    try {
        var regex = /\{[^{}]*"id":[0-9]+,"nombre":"[^"]+"[^{}]*\}/g;
        var matches = textoParadas.match(regex);
        NOMBRES_PARADAS = {}; // Limpiar caché anterior
        if (matches) {
            matches.forEach(function(s) {
                var obj = JSON.parse(s);
                NOMBRES_PARADAS[obj.id] = obj.nombre;
            });
        }
        console.log("Paradas procesadas:", Object.keys(NOMBRES_PARADAS).length);
    } catch (e) {
        console.error("Error procesando paradas:", e);
    }
}

function pintarLlegadas(dataLlegadas) {
    console.log("Pintando llegadas...");
    var cont = document.getElementById("contenedor");
    cont.innerHTML = ""; // Limpiar contenido anterior

    if (!dataLlegadas || !dataLlegadas.buses || !dataLlegadas.buses.lineas) {
        console.warn("Datos de llegadas incompletos o vacíos.");
        cont.innerHTML = '<p style="color:white;font-size:24px;">No hay llegadas programadas.</p>';
        return;
    }

    var lineas = dataLlegadas.buses.lineas;

    lineas.forEach(function(linea) {
        var config = LINEA_INFO[linea.linea] || { nombre: "Línea " + linea.linea, color: "#444" };
        var COLOR_VIVO = {
            500: "#6792bc",
            300: "#be8b00",
            301: "#d3b255"
        };

        var bloque = document.createElement("div");
        bloque.style.display = "flex";
        bloque.style.alignItems = "stretch";
        bloque.style.marginBottom = "15px";
        bloque.style.borderRadius = "10px";
        bloque.style.overflow = "hidden";
        bloque.style.background = config.color;
        bloque.style.padding = "0";

        var lineaDiv = document.createElement("div");
        lineaDiv.textContent = config.nombre.replace("Línea ","");
        lineaDiv.style.width = "120px";
        lineaDiv.style.background = COLOR_VIVO[linea.linea] || "#666";
        lineaDiv.style.color = "#fff";
        lineaDiv.style.fontSize = "60px";
        lineaDiv.style.fontWeight = "bold";
        lineaDiv.style.display = "flex";
        lineaDiv.style.alignItems = "center";
        lineaDiv.style.justifyContent = "center";
        lineaDiv.style.flexShrink = "0";

        bloque.appendChild(lineaDiv);

        var llegadasDiv = document.createElement("div");
        llegadasDiv.style.display = "flex";
        llegadasDiv.style.flexDirection = "column";
        llegadasDiv.style.gap = "8px";
        llegadasDiv.style.padding = "10px";
        llegadasDiv.style.flexGrow = "1";
        llegadasDiv.style.background = config.color;

        linea.buses.forEach(function(bus) {
            var elem = document.createElement("div");
            elem.style.display = "flex";
            elem.style.alignItems = "center";
            elem.style.gap = "8px";

            var minutos = document.createElement("span");
            minutos.textContent = (bus.tiempo === "0" || bus.tiempo === 0) ? "En la parada" : bus.tiempo + " min";
            minutos.style.fontWeight = "bold";
            minutos.style.fontSize = "38px";
            minutos.style.whiteSpace = "nowrap"; 
            minutos.style.flexShrink = "0";

            var nombreParada = document.createElement("span");
            var ultima = NOMBRES_PARADAS[bus.ult_parada]; // Usar el diccionario global
            if (ultima) {
                nombreParada.textContent = "· " + ultima;
                nombreParada.style.fontStyle = "italic";
                nombreParada.style.fontWeight = "300";
                nombreParada.style.fontSize = "20px";
                nombreParada.style.whiteSpace = "nowrap";
                nombreParada.style.overflow = "hidden";
                nombreParada.style.textOverflow = "ellipsis";
                nombreParada.style.minWidth = "0"; 
            }

            elem.appendChild(minutos);
            elem.appendChild(nombreParada);
            llegadasDiv.appendChild(elem);
        });

        bloque.appendChild(llegadasDiv);
        cont.appendChild(bloque);
    });
}

function pintarHorarios(dataHorarios) {
    console.log("Pintando horarios...");
    var cont = document.getElementById("horarios");
    cont.innerHTML = ""; // Limpiar horarios anteriores

    var ahora = horaActualInt();
    
    // --- LÍNEA 5 (SALIDAS) ---
    var info5 = dataHorarios.linea5 && dataHorarios.linea5.servicios ? dataHorarios.linea5.servicios[0] : null;
    if (info5 && info5.ida) {
        var futuros5 = info5.ida
            .filter(function(h) { return h > ahora; })
            .slice(0, 8);
        
        var config5 = LINEA_INFO[500];
        var div5 = document.createElement("div");
        div5.className = "linea";
        div5.style.background = "#6792bc";
        div5.innerHTML = "<h2>" + config5.nombre + " — Horarios de ida</h2>";
        
        var lista5 = document.createElement("div");
        lista5.className = "horarios-lista";
        
        pintarCajasHorario(lista5, futuros5, config5);
        div5.appendChild(lista5);
        cont.appendChild(div5);
    }

    // --- LÍNEA 3 (LLEGADAS) ---
    var info3 = dataHorarios.linea3 && dataHorarios.linea3.servicios ? dataHorarios.linea3.servicios[0] : null;
    if (info3 && info3.vuelta) {
        var futuros3 = info3.vuelta
            .filter(function(h) { return h > ahora; })
            .slice(0, 8);
        
        var config3 = LINEA_INFO[300];
        var div3 = document.createElement("div");
        div3.className = "linea";
        div3.style.background = quitarAlpha(config3.color);
        div3.innerHTML = "<h2>" + config3.nombre + " — Horarios de vuelta</h2>";
        
        var lista3 = document.createElement("div");
        lista3.className = "horarios-lista";
        
        pintarCajasHorario(lista3, futuros3, config3);
        div3.appendChild(lista3);
        cont.appendChild(div3);
    }
    
    // --- LÍNEA 3A (LLEGADAS) ---
    var info3A = dataHorarios.linea3A && dataHorarios.linea3A.servicios ? dataHorarios.linea3A.servicios[0] : null;
    if (info3A && info3A.vuelta) {
        var futuros3A = info3A.vuelta
            .filter(function(h) { return h > ahora; })
            .slice(0, 8);
        
        var config3A = LINEA_INFO[301];
        var div3A = document.createElement("div");
        div3A.className = "linea";
        div3A.style.background = quitarAlpha(config3A.color);
        div3A.innerHTML = "<h2>" + config3A.nombre + " — Horarios de vuelta</h2>";
        
        var lista3A = document.createElement("div");
        lista3A.className = "horarios-lista";
        
        pintarCajasHorario(lista3A, futuros3A, config3A);
        div3A.appendChild(lista3A);
        cont.appendChild(div3A);
    }
}

function pintarClima(dataClima) {
    console.log("Pintando clima...");
    var bandaLluvia = document.getElementById("banda-lluvia");
    var ahora = new Date();
    var textoLluvia = '<span style="font-size: 40px; margin-right: 8px;">☀</span> Sin lluvias';

    if (!dataClima || !dataClima.hourly || !dataClima.hourly.time) {
        bandaLluvia.innerHTML = textoLluvia; // Mostrar sol por defecto
        return;
    }
    
    var tiempos = dataClima.hourly.time;
    var pops = dataClima.hourly.precipitation_probability;
    var lista = tiempos.map(function(t, i) {
        return { hora: new Date(t), pop: pops[i] };
    });

    for (var i = 0; i < lista.length; i++) {
        var item = lista[i];
        if (item.pop >= 40) {
            var lluviaHora = item.hora;
            var diffMs = lluviaHora - ahora;
            var diffHoras = diffMs / (1000 * 60 * 60);
            var diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffHoras < 0) continue;
            if (diffDias > 5) continue;

            if (diffHoras >= 0 && diffHoras <= 6) {
                textoLluvia = '<span style="font-size: 40px; margin-right: 8px;">⛆</span> Lluvia en ' + Math.ceil(diffHoras) + ' hora' + (Math.ceil(diffHoras) > 1 ? 's' : '');
            } 
            else if (lluviaHora.getDate() === ahora.getDate()) {
                textoLluvia = '<span style="font-size: 40px; margin-right: 8px;">⛆</span> Lluvia a las ' + lluviaHora.getHours().toString().padStart(2,"0") + ':00';
            }
            else if (diffDias === 1 || (ahora.getHours() < 4 && lluviaHora.getDate() === ahora.getDate())) {
                textoLluvia = '<span style="font-size: 40px; margin-right: 8px;">⛆</span> Lluvia mañana';
            }
            else if (diffDias > 1 && diffDias <= 5) {
                var diasSemana = ["domingo","lunes","martes","miércoles","jueves","viernes","sábado"];
                textoLluvia = '<span style="font-size: 40px; margin-right: 8px;">⛆</span> Lluvia el ' + diasSemana[lluviaHora.getDay()];
            }
            break;
        }
    }
    bandaLluvia.innerHTML = textoLluvia;
}

function pintarNoticias(dataNoticias) {
    console.log("Pintando noticias...");
    var inner = document.getElementById("ticker-inner");
    if (!inner) return;

    inner.innerHTML = ""; // Limpiar ticker

    var noticias = dataNoticias.items.slice(0, 10).map(function(item) {
        return item.title;
    });

    var crearItems = function() {
        noticias.forEach(function(titulo, i) {
            var span = document.createElement("span");
            span.className = "ticker-item";
            span.textContent = titulo;
            inner.appendChild(span);
        });
    };

    crearItems(); // Primera copia
    crearItems(); // Segunda copia

    if (animacionActiva) {
        try { cancelAnimationFrame(animacionActiva); } catch(e) {}
        animacionActiva = null;
    }
    
    setTimeout(function() {
        iniciarTickerNoticias();
    }, 200); // Esperar a que el DOM se pinte
}


// ============================
// FUNCIONES AUXILIARES
// (Copiadas de tu script original)
// ============================

// --- Para Reloj y Modo Oscuro ---

function actualizarReloj() {
    var ahora = new Date();
    var fecha = ahora.toLocaleDateString("es-ES", {
        weekday: "long",
        month: "long",
        day: "numeric"
    });
    var hora = ahora.toLocaleTimeString("es-ES", { hour12: false });

    var elem = document.getElementById("hora");
    if (elem) {
        elem.innerHTML = fecha + " — " + hora;
    }
}

function aplicarModoClaroOscuro() {
    var ahora = new Date();
    var hora = ahora.getHours();
    var llegadaTitulo = document.getElementById("titulo-llegadas");
    var horariosTitulo = document.getElementById("titulo-horarios");

    if (hora >= 10 && hora < 18) {
        document.body.style.background = "#764e50";
    } else {
        document.body.style.background = "#764e50";
    }
    // Estos colores eran iguales, los dejo como en tu original
    if (llegadaTitulo) llegadaTitulo.style.color = "#ffffff";
    if (horariosTitulo) horariosTitulo.style.color = "#ffffff";
}

// --- Para Horarios ---

function pintarCajasHorario(lista, futuros, config) {
    // Función de ayuda para no repetir código en 'pintarHorarios'
    if (futuros.length === 0) {
        var sinBuses = document.createElement("div");
        sinBuses.textContent = "Ya no quedan autobuses.";
        sinBuses.style.fontSize = "24px";
        sinBuses.style.color = "#ffffff";
        sinBuses.style.padding = "10px";
        lista.appendChild(sinBuses);
    } else {
        futuros.forEach(function(h) {
            var caja = document.createElement("div");
            caja.className = "horario-caja";
            caja.textContent = formatearHora(h);
            caja.style.background = config.color;
            caja.style.color = "#ffffff";
            lista.appendChild(caja);
        });
    }
}

function formatearHora(num) {
    var s = String(num).padStart(4, "0");
    return s.slice(0,2) + ":" + s.slice(2);
}

function horaActualInt() {
    var d = new Date();
    return d.getHours() * 100 + d.getMinutes();
}

function quitarAlpha(color) {
    return color.length === 9 ? color.slice(0, 7) : color;
}

// --- Para Ticker de Noticias ---

function iniciarTickerNoticias() {
    var inner = document.getElementById("ticker-inner");
    if (!inner) return; // Comprobación básica

    var anchoMitad = 0; // Empezar en 0
    var x = 0;
    var velocidad = 1.5;

    // Polyfill para requestAnimationFrame para navegadores antiguos
    var raf = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
              window.webkitRequestAnimationFrame || window.msRequestAnimationFrame ||
              function(cb) { return window.setTimeout(cb, 1000/60); };
    
    var caf = window.cancelAnimationFrame || window.mozCancelAnimationFrame ||
              function(id) { clearTimeout(id); };
    
    if (animacionActiva) {
        caf(animacionActiva); // Cancelar animación anterior si existe
    }

    function animar() {
        // --- INICIO DE LA SOLUCIÓN ---
        // Si el ancho aún no se ha calculado, intentamos calcularlo.
        // Esto espera a que el navegador haya "pintado" el contenido.
        if (anchoMitad === 0) {
            anchoMitad = inner.scrollWidth / 2;
            
            // Si sigue siendo 0, o si el contenido no es lo bastante ancho
            // para necesitar scroll, detenemos la animación.
            if (anchoMitad === 0 || (inner.scrollWidth <= inner.clientWidth)) {
                anchoMitad = 0; // resetear
                return; // Detener el bucle de animación
            }
        }
        // --- FIN DE LA SOLUCIÓN ---

        x -= velocidad;
        
        if (Math.abs(x) >= anchoMitad) {
            x = 0; // Reiniciar el bucle
        }
        
        // Mantener el centrado vertical y mover horizontalmente
        inner.style.transform = "translateY(-50%) translateX(" + x + "px)";
        animacionActiva = raf(animar);
    }

    animar(); // Empezar la animación
}


// ============================
// INICIALIZACIÓN Y REFRESCOS
// ============================

// --- Reloj y Modo Oscuro (se ejecutan siempre) ---
setInterval(actualizarReloj, 1000);
actualizarReloj();

aplicarModoClaroOscuro();
setInterval(aplicarModoClaroOscuro, 60000);

// --- Carga de Datos (al cargar la página) ---
document.addEventListener("DOMContentLoaded", function() {
    cargarDatosDelWrapper();
    
    // Refrescar los datos cada 60 segundos
    setInterval(cargarDatosDelWrapper, 60000); 
});

</script>